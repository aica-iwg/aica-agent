from dataclasses import dataclass, field
from semver import VersionInfo
from typing import List, Union, Dict, Optional
from uuid import uuid4
from tools.serde_customized import serialize

from cyst.api.configuration.configuration import ConfigItem
from cyst.api.logic.exploit import ExploitParameterType, ExploitCategory, ExploitLocality


@serialize
@dataclass
class VulnerableServiceConfig(ConfigItem):
    # There is a discrepancy between config.name and vulnerableservice.id. This is because the id is internal to
    # config items and no configurable object should have an id that is not unique to scenario. These things should
    # be names, types or whatever
    name: str
    min_version: Union[VersionInfo, str]
    max_version: Union[VersionInfo, str] = field(default="0.0.0")
    id: str = field(default_factory=lambda: str(uuid4()))


@serialize
@dataclass
class ExploitParameterConfig(ConfigItem):
    type: ExploitParameterType
    value: Optional[str] = None
    immutable: bool = True
    id: str = field(default_factory=lambda: str(uuid4()))


@serialize
@dataclass
class ExploitConfig:
    services: List[Union[VulnerableServiceConfig, str]]
    locality: ExploitLocality
    category: ExploitCategory
    parameters: Optional[List[ExploitParameterConfig]] = None
    id: str = field(default_factory=lambda: str(uuid4()))
